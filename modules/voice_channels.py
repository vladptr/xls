import discord
from discord.ui import View, Select, Button
import time
import asyncio
import random
from modules.config import TRIGGER_CHANNELS, BLACKLISTED_CHANNELS, bot

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
setup_messages = {}
channel_locks = {}
room_modes = {}
last_rename_times = {}
created_channels = {}
channel_bases = {}

async def get_channel_lock(channel_id):
    if channel_id not in channel_locks:
        channel_locks[channel_id] = asyncio.Lock()
    return channel_locks[channel_id]

# –í—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∫–æ–º–Ω–∞—Ç—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
class RoomTypeSelect(Select):
    def __init__(self, user_id, channel_id, mode="default"):
        # mode: "default" –¥–ª—è —Ä–∞–Ω–∫–µ–¥/–ø–∞–±–ª–∏–∫, "custom" –¥–ª—è –∫–∞—Å—Ç–æ–º–æ–∫
        if mode == "custom":
            options = [
                discord.SelectOption(label="Valorant", value="üéÆ„ÉªValorant"),
                discord.SelectOption(label="Among Us", value="üéÆ„ÉªAmong Us"),
                discord.SelectOption(label="CS:GO", value="üéÆ„ÉªCS:GO"),
                discord.SelectOption(label="Pummel party", value="üéÆ„ÉªPummel party"),
                discord.SelectOption(label="PICO PACK", value="üéÆ„ÉªPICO PACK"),
                discord.SelectOption(label="Dota 2", value="‚ôø„ÉªDota 2"),
                discord.SelectOption(label="Apex Legends", value="üéÆ„ÉªApex Legends"),
                discord.SelectOption(label="WARZONE", value="üéÆ„ÉªWARZONE"),
                discord.SelectOption(label="Rocket League", value="üéÆ„ÉªRocket League"),
                discord.SelectOption(label="Helldivers 2", value="üéÆ„ÉªHelldivers 2"),
            ]
        else:
            options = [
                discord.SelectOption(label="–î—É–æ", value="üë•„Éª–î—É–æ"),
                discord.SelectOption(label="–°–∫–≤–∞–¥", value="üë•„Éª–°–∫–≤–∞–¥"),
                discord.SelectOption(label="–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π", value="üë•„Éª–°–∫–≤–∞–¥+")
            ]
        super().__init__(placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã", min_values=1, max_values=1, options=options)
        self.user_id = user_id
        self.channel_id = channel_id
        self.mode = mode

    async def callback(self, interaction: discord.Interaction):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("–¢—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É!", ephemeral=True)
            return

        now = time.time()
        last_time = last_rename_times.get(self.channel_id, 0)
        cooldown = 660  # —Å–µ–∫—É–Ω–¥—ã

        if now - last_time < cooldown:
            remaining = round(cooldown - (now - last_time), 1)
            await interaction.response.send_message(
                f"–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ {cooldown} —Å–µ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë {remaining} —Å–µ–∫. –ù–µ –∑–∞—ë–±—ã–≤–∞–π –±–æ—Ç–∞ –∏–Ω–∞—á–µ –±—É–¥–µ—à—å –ø–æ—Å–ª–∞–Ω –Ω–∞—Ö—É–π!", ephemeral=True
            )
            return

        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
        last_rename_times[self.channel_id] = now

        channel = interaction.guild.get_channel(self.channel_id)
        if channel:
            await channel.edit(name=self.values[0])
            await interaction.response.send_message(f"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞: **{self.values[0]}**", ephemeral=True)
        else:
            await interaction.response.send_message("–ö–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!", ephemeral=True)

class PlayerCountSelect(Select):
    def __init__(self, user_id, channel_id, mode="default"):
        if mode == "custom":
            options = [
                discord.SelectOption(label=f"+{i}", value=str(i)) for i in range(1, 11)
            ] + [discord.SelectOption(label="–Ω–µ –∏—Å–∫–∞—Ç—å", value="none")]
        else:
            options = [
                discord.SelectOption(label="1Ô∏è‚É£", value="1"),
                discord.SelectOption(label="2Ô∏è‚É£", value="2"),
                discord.SelectOption(label="3Ô∏è‚É£", value="3"),
                discord.SelectOption(label="–Ω–µ –∏—Å–∫–∞—Ç—å", value="none")
            ]
        super().__init__(placeholder="–°–∫–æ–ª—å–∫–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω—É–∂–Ω–æ?", min_values=1, max_values=1, options=options)
        self.user_id = user_id
        self.channel_id = channel_id
        self.mode = mode

    async def callback(self, interaction: discord.Interaction):
        if interaction.user.id != self.user_id:
            await interaction.response.send_message("–¢—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª —ç—Ç—É –∫–æ–º–Ω–∞—Ç—É!", ephemeral=True)
            return

        selection = self.values[0]
        if selection == "none":
            await interaction.response.send_message("–í—ã–±—Ä–∞–Ω –≤–∞—Ä–∏–∞–Ω—Ç '–ù–µ –∏—Å–∫–∞—Ç—å', —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.", ephemeral=True)
            return

        guild = interaction.guild
        voice_channel = guild.get_channel(self.channel_id)
        if not voice_channel:
            await interaction.response.send_message("–ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!", ephemeral=True)
            return

        text_channel = discord.utils.get(guild.text_channels, name="üí¨„Éªchat")
        if not text_channel:
            await interaction.response.send_message("–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª '–ø–æ–∏—Å–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω!", ephemeral=True)
            return

        count = self.values[0]
        msg = f"+{count} <@&1159121098965786634> <#{voice_channel.id}> {interaction.user.mention}"
        sent_msg = await text_channel.send(msg)
        await interaction.response.send_message("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–∞–Ω–∞–ª '–ø–æ–∏—Å–∫'.", ephemeral=True)

        # –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞
        await asyncio.sleep(10800)
        await sent_msg.delete()

class RoomSetupView(View):
    def __init__(self, user_id, channel_id, mode="default"):
        super().__init__(timeout=300000)
        self.add_item(RoomTypeSelect(user_id, channel_id, mode))
        self.add_item(PlayerCountSelect(user_id, channel_id, mode))

